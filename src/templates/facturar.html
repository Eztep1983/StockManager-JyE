{% extends "base.html" %}

{% block title %} Facturar {% endblock %}

{% block body %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vender</title>
</head>
<body id="color-facturar">
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul>
                {% for category, message in messages %}
                    <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
                </ul>
            {% endif %}
            {% endwith %}
    <div class="mdl-layout mdl-js-layout">
        <!-- Navegación -->
        <nav class="mdl-navigation">
            <button class="mdl-button mdl-js-button mdl-button--icon mdl-layout__drawer-button">
                <span class="gg-menu"></span>
            </button>
            <a id="logoutLink" href="{{ url_for('logout') }}" style="margin-left: auto;">
                <i class="fas fa-sign-out-alt"></i> Salir
            </a>
        </nav>
        <div class="mdl-layout__drawer">
            <center>
                <span class="mdl-layout-title" style="margin-bottom:10px;">{{ current_user.fullname }}</span>
            </center>
            <nav class="mdl-navigation">
                <a href="/home">Inicio</a><br><br>
                <a href="/productos">Productos</a><br><br>
                <a href="/ventas">Ventas</a><br><br>
                <a href="/proveedores">Proveedores</a><br><br>
                <a href="/clientes">Clientes</a><br><br>
            </nav>
        </div>
        <!-- Contenido principal -->
        <main class="mdl-layout__content">
            <header>
                <center><div class="titulo">FACTURACION</div></center>
                <br>
            </header>
            <form id="formulario-facturacion" method="POST" action="/facturar">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <!-- Información de la Venta -->
                <div>
                <center>
                        <label for="id_usuario">Usuario:</label>
                        <br>
                    <span>{{ current_user.fullname }}</span>
                    <input type="hidden" name="id_usuario" value="{{ current_user.id }}">
                </center>
                </div>
            
                <div>
                    <label for="id_cliente">Cliente:</label>
                    <select id="id_cliente" name="id_cliente">
                        <option value="">Seleccionar Cliente</option>
                        {% for cliente in lista_clientes %}
                            <option value="{{ cliente.identificador_c }}">{{ cliente.nombres }} {{ cliente.apellidos }}</option>
                        {% endfor %}
                    </select>
                </div>
            
                <div>
                    <label for="fecha_venta">Fecha de Venta:</label>
                    <input type="date" id="fecha_venta" name="fecha_venta">
                </div>
            
                <div>
                    <label for="hora_venta">Hora de Venta:</label>
                    <input type="time" id="hora_venta" name="hora_venta">
                </div>
            
                <!-- Tabla de Productos/Servicios -->
                <div>
                    <table id="tabla-productos">
                        <thead>
                            <tr>
                                <th>Producto/Servicio</th>
                                <th>Cantidad</th>
                                <th>Precio Unitario</th>
                                <th>Subtotal</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="fila-producto">
                                <td>
                                    <select class="producto" name="productos[]">
                                        {% for producto in lista_productos %}
                                        <option value="{{ producto.identificador_p }}">{{ producto.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                    <input type="text" class="servicio" name="servicio[]" placeholder="Describir servicio">
                                </td>
                                <td>
                                    <input type="number" class="cantidad" name="cantidad[]" min="1">
                                </td>
                                <td>
                                    <input type="number" class="precio" name="precio[]" step="0.01">
                                </td>
                                <td>
                                    <input type="number" class="subtotal" name="subtotal[]" readonly>
                                </td>
                                <td>
                                    <button type="button" class="quitar-producto">Quitar</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <button type="button" id="agregar-producto">Agregar Producto</button>                    
                </div>
                <!-- Total -->
                <div>
                    <label for="total">Total:</label>
                    <input type="number" id="total" name="total" readonly>
                </div>
            
                <!-- Información del Pago -->
                <div>
                    <label for="fecha_pago">Fecha de Pago:</label>
                    <input type="date" id="fecha_pago" name="fecha_pago">
                </div>
            
                <div>
                    <label for="hora_pago">Hora de Pago:</label>
                    <input type="time" id="hora_pago" name="hora_pago">
                </div>
            
                <!-- Notas -->
                <div>
                    <label for="notas">Nota:</label>
                    <textarea id="notas" name="notas"></textarea>
                </div>
            
                <button type="submit">Facturar</button>
            </form>            
        </main>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const tablaProductos = document.querySelector("#tabla-productos tbody");
            const agregarProductoBtn = document.querySelector("#agregar-producto");
            const totalInput = document.querySelector("input[name='total']");
    
            // Función para actualizar el subtotal de una fila
            function actualizarSubtotal(fila) {
                const cantidadInput = fila.querySelector(".cantidad");
                const precioInput = fila.querySelector(".precio");
                const subtotalInput = fila.querySelector(".subtotal");
    
                const cantidad = parseFloat(cantidadInput.value) || 0;
                const precio = parseFloat(precioInput.value) || 0;
                const subtotal = cantidad * precio;
    
                subtotalInput.value = subtotal.toFixed(2);
                actualizarTotal();
            }
    
            // Función para actualizar el total general
            function actualizarTotal() {
                let total = 0;
                tablaProductos.querySelectorAll(".subtotal").forEach((subtotalInput) => {
                    total += parseFloat(subtotalInput.value) || 0;
                });
                totalInput.value = total.toFixed(2);
            }
    
            // Función para agregar una nueva fila de producto
            function agregarFilaProducto() {
                const filaBase = document.querySelector(".fila-producto");
                const nuevaFila = filaBase.cloneNode(true);
    
                // Limpiar los campos de la nueva fila
                nuevaFila.querySelectorAll("input, select").forEach((input) => {
                    if (input.type === "number" || input.type === "text") {
                        input.value = "";
                    }
                });
    
                // Agregar eventos a los nuevos campos
                nuevaFila.querySelector(".cantidad").addEventListener("input", function () {
                    actualizarSubtotal(nuevaFila);
                });
    
                nuevaFila.querySelector(".precio").addEventListener("input", function () {
                    actualizarSubtotal(nuevaFila);
                });
    
                nuevaFila.querySelector(".quitar-producto").addEventListener("click", function () {
                    quitarFilaProducto(nuevaFila);
                });
    
                tablaProductos.appendChild(nuevaFila);
            }
    
            // Función para quitar una fila de producto
            function quitarFilaProducto(fila) {
                if (tablaProductos.children.length > 1) {
                    fila.remove();
                    actualizarTotal();
                } else {
                    alert("No puedes eliminar el único producto.");
                }
            }
    
            // Evento para agregar una fila de producto
            agregarProductoBtn.addEventListener("click", agregarFilaProducto);
    
            // Eventos iniciales para la primera fila
            document.querySelectorAll(".cantidad, .precio").forEach((input) => {
                input.addEventListener("input", function () {
                    const fila = input.closest("tr");
                    actualizarSubtotal(fila);
                });
            });
    
            document.querySelectorAll(".quitar-producto").forEach((button) => {
                button.addEventListener("click", function () {
                    const fila = button.closest("tr");
                    quitarFilaProducto(fila);
                });
            });
        });
    </script>
    
</body>
</html>
{% endblock %}
